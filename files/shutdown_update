#!/bin/sh

fun_update() {

    /bin/plymouth change-mode --updates
    /bin/plymouth system-update --progress=0
    fun_plymouth_update & fun_plymouth_update_pid=$!
    /usr/bin/pamac update -a --force-refresh --enable-downgrade --no-confirm > /var/log/manjaro-automatic-update/update_status.txt
    /usr/bin/pamac remove -o --no-confirm >> /var/log/manjaro-automatic-update/update_status.txt
    kill $fun_plymouth_update_pid
    /bin/plymouth system-update --progress=100
    sleep 3
    /bin/plymouth change-mode --shutdown
}

fun_plymouth_update() {
    while :
    do
        grepper=$(grep -aoP '((^[0-9]*(,[0-9]*)?( | )(GB|kB|MB|Bytes)\/[0-9]*(,[0-9]*)?( | )(GB|kB|MB|Bytes))|(?<=\[)[0-9]*\/[0-9]*(?=\]$))' /var/log/manjaro-automatic-update/update_status.txt | tail -1)
        if echo "$grepper" | grep -qP '(kB|MB|GB|Bytes)';
        then
            first=$(echo "$grepper" | grep -aoP '[0-9]*(,[0-9]*)?(?=( | )(GB|kB|MB|Bytes)\/)')
            second=$(echo "$grepper" | grep -aoP '(?<=\/)[0-9]*(,[0-9]*)?')
            head=$(echo "$grepper" | grep -aoP '(kB|MB|GB|Bytes)' | head -1)
            tail=$(echo "$grepper" | grep -aoP '(kB|MB|GB|Bytes)' | tail -1)
            if echo "$head" | grep -qP 'Bytes';
            then
                counter=0
            elif echo "$head" | grep -qP 'kB';
            then
                counter=1
            elif echo "$head" | grep -qP 'MB';
            then
                counter=2
            elif echo "$head" | grep -qP 'GB';
            then
                counter=3
            fi
            if echo "$tail" | grep -qP 'Bytes';
            then
                counter=$((0-counter))
            elif echo "$tail" | grep -qP 'kB';
            then
                counter=$((1-counter))
            elif echo "$tail" | grep -qP 'MB';
            then
                counter=$((2-counter))
            elif echo "$tail" | grep -qP 'GB';
            then
                counter=$((3-counter))
            fi
            if [ 0 -gt $counter ];
            then
                counter=0
            fi
            grepper=$(echo "scale=2; ${first/,/.} / (${second/,/.} * (1000^$counter))" | bc)
        fi
        preprog=$(echo "scale=2 ; $grepper * 100" | bc)
        prog=${preprog%.*}
        /bin/plymouth system-update --progress "$prog"
        sleep 0.1
    done
}
if ! (systemctl list-jobs | grep -E -q 'reboot.target.*start');
then
    while ! /bin/plymouth --ping;
    do
        sleep 0.5
    done
    if ! upower -e | grep -qP '/org/freedesktop/UPower/devices/battery_BAT1' || ( [ "$(upower -i /org/freedesktop/UPower/devices/battery_BAT1 | grep -aoP '(?<=percentage:          )[0-9]*(?=%)')" -ge 50 ] && upower -i /org/freedesktop/UPower/devices/battery_BAT1 | grep -qP '(?<=state:               )charging' );
    then
        /bin/plymouth display-message --text "Searching for Updates..."
        if ! /usr/bin/pamac checkupdates -a; then
            fun_update & wait
        else
            /bin/plymouth display-message --text "No updates found!"
            sleep 3
        fi
        /bin/plymouth display-message --text ""
    fi
fi
